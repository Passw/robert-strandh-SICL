\chapter{Call-site manager}
\label{chap-call-site-manager}

The contents of this chapter is a summary and an update of the paper
we published in ELS 2021 \cite{DBLP:conf/els/Strandh21}.

In the most general case, an external function is called approximately
like this:
\begin{enumerate}
\item Compute the callee and the arguments into temporary locations.
\item Remember the value of the stack pointer in a lexical variable.
\item Push the frame pointer onto the stack.
\item Load the rack of the callee into a free register.
\item Load the static environment from the rack into a dedicated
  register.
\item Load the initial frame size of the callee into a free register.
\item Subtract the initial frame size of the callee from the stack
  pointer.
\item Push the arguments onto the stack.
\item Load the dynamic environment into a dedicated register.
\item Store the remembered value of the stack pointer (minus 1) into
  the frame pointer, thereby establishing an initial frame for the
  callee.
\item Execute an instruction such as \texttt{call}.
\end{enumerate}

As we can see, all arguments are passed on the stack, which is
obviously not optimal.  The initial frame of the callee is what the
callee needs in order to parse the arguments into its own lexical
variables.  Parsing the arguments is done by a part of the function
called the \emph{prelude}.

When the callee is about to return to the caller, it follows the
following approximate steps:

\begin{enumerate}
\item Compute the return values into temporary locations.
\item Remember the contents of the stack at the frame-pointer
  location, which is the frame pointer of the caller.
\item Store the values onto the stack, starting with the first values
  overwriting the caller frame pointer.
\item In a dedicated register, store the first return value, or
  \texttt{nil} if there are no return values.
\item Execute an instruction such as \texttt{return}.
\end{enumerate}

The values returned by the callee are now on top of the stack, between
the remembered value of the stack pointer and the real stack pointer,
so that they are part of the stack frame of the caller.  Again, all
values are on the stack, and the number of values must be determined
by subtracting the remembered value of the stack pointer and the real
stack pointer.  The only exception is when the caller needs exactly
one return value, in which case, it can access the dedicated register.


% LocalWords:  callee
